/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2022 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include <stdint.h>
#include<stdio.h>

//Define functions
void delay_loop(uint32_t);

int main(void)
{
	//Address pointer definitions
	uint32_t volatile *const pPDClkCtrlReg 	= (uint32_t *)0x40023830;
	uint32_t volatile *const pPDModeReg 	= (uint32_t *)0x40020C00;
	uint32_t volatile *const pPDOutReg 		= (uint32_t *)0x40020C14;
	uint32_t volatile *const pPDInReg 		= (uint32_t *)0x40020C10;
	uint32_t volatile *const pPDPupdrReg	= (uint32_t *)0x40020C0C;

	//1. Enable Clock For GPIOD
	*pPDClkCtrlReg |= 0x08;

	//2. Enable output mode for rows and input mode for cols
	*pPDModeReg &= ~(0xFF00FF); //clearing
	*pPDModeReg |= (0x000055); //setting

	//3. set pull up resistors for input pins
	*pPDPupdrReg &= ~(0xFF << 16); //clear
	*pPDPupdrReg |= (0x55 << 16); //set

	//4. Make all rows to HIGH state
	*pPDOutReg |= 0x0F;

	uint16_t status = 1;
    /* Loop forever */
	for(;;){

		status = 1;
		//4. Make all rows to HIGH state
		*pPDOutReg |= 0x0F;
		*pPDOutReg &= ~(0x01); // Make R1 low only and read cols step by step

		// Read C1
		status = *pPDInReg & (1 << 8);
		if(!status){
			delay_loop(2000);
			printf("1\n");
		}
		// Read C2
		status = *pPDInReg & (1 << 9);
		if(!status){
			delay_loop(2000);
			printf("2\n");
		}
		// Read C3
		status = *pPDInReg & (1 << 10);
		if(!status){
			delay_loop(2000);
			printf("3\n");
		}
		// Read C4
		status = *pPDInReg & (1 << 11);
		if(!status){
			delay_loop(2000);
			printf("A\n");
		}

		//4. Make all rows to HIGH state
		*pPDOutReg |= 0x0F;

		// Make R2 low only and read cols step by step
		*pPDOutReg &= ~(0x02);

		// Read C1

		status = *pPDInReg & (1 << 8);
		if(!status){
			delay_loop(2000);
			printf("4\n");
		}
		// Read C2

		status = *pPDInReg & (1 << 9);
		if(!status){
			delay_loop(2000);
			printf("5\n");
		}
		// Read C3

		status = *pPDInReg & (1 << 10);
		if(!status){
			delay_loop(2000);
			printf("6\n");
		}
		// Read C4

		status = *pPDInReg & (1 << 11);
		if(!status){
			delay_loop(2000);
			printf("B\n");
		}

		//4. Make all rows to HIGH state
		*pPDOutReg |= 0x0F;

		// Make R3 low only and read cols step by step
		*pPDOutReg &= ~(0x04);

		// Read C1

		status = *pPDInReg & (1 << 8);
		if(!status){
			delay_loop(2000);
			printf("7\n");
		}
		// Read C2

		status = *pPDInReg & (1 << 9);
		if(!status){
			delay_loop(2000);
			printf("8\n");
		}
		// Read C3

		status = *pPDInReg & (1 << 10);
		if(!status){
			delay_loop(2000);
			printf("9\n");
		}
		// Read C4

		status = *pPDInReg & (1 << 11);
		if(!status){
			delay_loop(2000);
			printf("C\n");
		}

		//4. Make all rows to HIGH state
		*pPDOutReg |= 0x0F;

		// Make R4 low only and read cols step by step
		*pPDOutReg &= ~(0x08);

		// Read C1

		status = *pPDInReg & (1 << 8);
		if(!status){
			delay_loop(2000);
			printf("*\n");
		}
		// Read C2

		status = *pPDInReg & (1 << 9);
		if(!status){
			delay_loop(2000);
			printf("0\n");
		}
		// Read C3

		status = *pPDInReg & (1 << 10);
		if(!status){
			delay_loop(2000);
			printf("#\n");
		}
		// Read C4

		status = *pPDInReg & (1 << 11);
		if(!status){
			delay_loop(2000);
			printf("D\n");
		}

	};
}

void delay_loop(uint32_t t){
	for(uint32_t i=0; i<t*100; i++);
}
